{% extends 'app/layout/auth_base.html' %}
{% set text="Enter your new password and confirm it to reset your password." %}
{% block content %}
    <vue-form :state="reset_pwd_form" @submit.prevent="submit" class="form-horizontal" action="">
        <validate>
            <div class="form-group">
                <label for="password">New Password</label>
                <input pattern="[A-Za-z0-9@#$%^&+=]{8,}" required name="new_pwd" v-model="model.new_pwd"
                       type="password" class="form-control"
                       id="password"
                       placeholder="Enter new password">
                <field-messages name="new_pwd" show="$dirty || $touched"
                                class="form-control-feedback text-danger">
                    <div slot="required">Password is a required field</div>
                    <div slot="pattern">Password must have a minimum of eight characters.</div>
                </field-messages>
            </div>
        </validate>
        <validate :custom="{'match':match}">
            <div class="form-group">
                <label for="cpassword">Confirm Password</label>
                <input v-model="model.confirm_pwd" required pattern="[A-Za-z0-9@#$%^&+=]{8,}" name="confirm_pwd"
                       type="password"
                       class="form-control"
                       id="cpassword"
                       placeholder="Enter confirm password">
                <field-messages name="confirm_pwd" show="$dirty || $touched"
                                class="form-control-feedback text-danger">
                    <div slot="required">Confirm Password is a required field</div>
                    <div slot="pattern">Confirm Password must have a minimum of eight characters.</div>
                    <div slot="match">Confirm Password doesnt match new Password.</div>
                </field-messages>
            </div>
        </validate>
        <div class="mt-3">
            <button :disabled="reset_pwd_form.$invalid || processing"
                    class="btn btn-primary btn-block waves-effect waves-light"
                    type="submit">Reset Password
                <span v-if="processing">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span class="sr-only">Loading...</span>
                    </span>
            </button>
        </div>
    </vue-form>
    <script>
        Vue.use(window.VueForm)
        new Vue({
            'el': '#app',
            created() {
                axios.get("{{ url_for('api.auth_reset_password',token=token)}}").then(({data}) => {
                    console.log(data)
                }).catch((error) => {
                    console.log(error.response)
                    {#window.location.href = "{{ url_for('app.forgot_pwd') }}"#}
                })
            },
            methods: {
                submit: function () {
                    this.processing = true
                    if (!this.reset_pwd_form.$invalid) {
                        axios.put("{{ url_for('api.auth_reset_password',token=token)}}", this.model).then(({data}) => {
                            Swal.fire({
                                position: 'top-end',
                                title: 'Password Changed!',
                                type: "success",
                                text: `${data.message}`,
                                showConfirmButton: false,
                                timer: 1800
                            }).then(() => {
                                window.location.href = "{{ url_for('app.login')}}"
                            })
                        }).catch((error) => {
                            Swal.fire({
                                position: 'top-end',
                                title: 'Error!',
                                type: "error",
                                text: `${error.response.data.message}`,
                                showConfirmButton: false,
                                timer: 1800
                            })
                        })
                    }
                },

            },
            computed: {
                match: function (val) {
                    if (this.model.new_pwd !== this.model.confirm_pwd) {
                        return false
                    }
                    return true
                }
            },
            data: {
                processing: false,
                reset_pwd_form: {},
                model: {
                    new_pwd: '',
                    confirm_pwd: ''
                }
            }
        })
    </script>
{% endblock %}